# PaddleOCR 图纸识别 MLOps 方案
## 演示 PPT 大纲

---

## 封面

**基于 Amazon SageMaker 的 PaddleOCR MLOps 平台**

---

## 今天的内容

1. 整体方案架构
2. 模型版本管理 - SageMaker Model Registry
3. 增量训练 - SageMaker Pipelines
4. 数据标注 - SageMaker Ground Truth
5. 图形相似性检索 - OpenSearch
6. 下一步计划

---

## 一、整体方案架构

### 架构总览

```
┌────────────────────────────────────────────────────────────────┐
│                                                                │
│   ┌──────────┐      ┌──────────────────┐      ┌──────────┐    │
│   │  S3      │      │ SageMaker        │      │ Endpoint │    │
│   │  数据存储 │ ───▶ │ Training/Pipeline│ ───▶ │ 推理服务  │    │
│   └──────────┘      └──────────────────┘      └──────────┘    │
│        │                    │                                  │
│        │                    ▼                                  │
│   ┌────▼─────┐      ┌──────────────────┐                      │
│   │ Ground   │      │ Model Registry   │                      │
│   │ Truth    │      │ 版本管理          │                      │
│   │ 数据标注  │      └──────────────────┘                      │
│   └──────────┘                                                │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 能力对应

| 需求 | AWS 服务 |
|-----|---------|
| 模型版本管理 | SageMaker Model Registry |
| 增量训练自动化 | SageMaker Pipelines |
| 数据标注 | SageMaker Ground Truth |
| 模型部署 | SageMaker Endpoint |
| 图形相似性检索 | OpenSearch kNN |

---

## 二、模型版本管理 - SageMaker Model Registry

### 2.1 这个服务解决什么问题

- 模型迭代后，旧版本找不到了
- 不知道某个版本用的什么数据训练的
- 生产环境部署了哪个版本不清楚
- 出问题想回滚，不知道回滚到哪个版本

### 2.2 Model Registry 提供的能力

| 能力 | 说明 |
|-----|------|
| 版本管理 | 每次训练的模型自动编号 v1, v2, v3... |
| 元数据记录 | 记录每个版本的训练参数、数据集、评估指标 |
| 审批流程 | 模型需要审批通过才能部署到生产 |
| 版本对比 | 对比不同版本的指标，看哪个更好 |
| 一键部署 | 选中某个版本，直接部署成推理服务 |
| 回滚 | 随时切换到历史版本 |

### 2.3 操作步骤概要

**步骤1：创建模型组**
- 一个模型组管理同一个模型的所有版本
- 比如创建 `paddleocr-drawing-models` 组

**步骤2：注册模型版本**
- 训练完成后，把模型注册到组里
- 自动生成版本号
- 可以附带指标（准确率、召回率等）

**步骤3：审批**
- 新版本默认是"待审批"状态
- 审核指标后，改为"已审批"
- 只有已审批的版本才能部署

**步骤4：部署**
- 选择已审批的版本
- 一键部署到 SageMaker Endpoint

**步骤5：回滚（如需要）**
- 发现新版本有问题
- 选择旧版本重新部署

### 2.4 界面示意

```
Model Registry
└── paddleocr-drawing-models
    ├── v1  [Approved]   准确率: 85%   2024-01-01
    ├── v2  [Approved]   准确率: 89%   2024-01-15
    ├── v3  [Pending]    准确率: 91%   2024-01-20  ← 待审批
    └── v4  [Rejected]   准确率: 82%   2024-01-18  ← 被拒绝
```

---

## 三、增量训练 - SageMaker Pipelines

### 3.1 这个服务解决什么问题

- 每次有新数据，都要手动跑训练脚本
- 训练完还要手动评估、手动注册、手动部署
- 整个流程容易出错，难以复现

### 3.2 Pipelines 提供的能力

| 能力 | 说明 |
|-----|------|
| 流程编排 | 把多个步骤串成自动化流水线 |
| 条件判断 | 比如准确率达标才注册，否则告警 |
| 自动触发 | 新数据到了自动开始训练 |
| 执行记录 | 每次执行都有记录，可追溯 |
| 参数化 | 同一个 Pipeline，不同参数跑不同实验 |

### 3.3 增量训练 Pipeline 设计

```
┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐   ┌──────────┐
│ 数据预处理 │ → │ 加载基础  │ → │ 增量训练  │ → │ 模型评估  │ → │ 条件判断  │
│          │   │ 模型      │   │          │   │          │   │          │
└──────────┘   └──────────┘   └──────────┘   └──────────┘   └────┬─────┘
                                                                 │
                                                    ┌────────────┴────────────┐
                                                    │                         │
                                                    ▼                         ▼
                                              准确率 ≥ 85%              准确率 < 85%
                                                    │                         │
                                                    ▼                         ▼
                                              注册到 Registry            发送告警
```

### 3.4 增量训练 vs 全量训练

| 对比项 | 全量训练 | 增量训练 |
|-------|---------|---------|
| 数据 | 用全部历史数据 | 只用新增数据 |
| 时间 | 长（小时级） | 短（分钟级） |
| 成本 | 高 | 低 |
| 场景 | 模型架构大改 | 日常迭代优化 |

### 3.5 增量训练关键配置

| 配置项 | 作用 |
|-------|------|
| 指定基础模型 | 从上一版本继续训练，不从头开始 |
| 小学习率 | 避免把之前学到的东西忘掉 |
| 混合新旧数据 | 新数据70% + 旧数据30%，防止遗忘 |
| 冻结骨干网络 | 只训练最后几层，加快速度 |

---

## 四、数据标注 - SageMaker Ground Truth

### 4.1 这个服务解决什么问题

- 标注工具分散，有人用这个有人用那个
- 标注结果格式不统一
- 标注质量参差不齐
- 标注进度难以追踪

### 4.2 Ground Truth 提供的能力

| 能力 | 说明 |
|-----|------|
| 内置标注工具 | 支持框选、分割、文字输入等 |
| 自定义模板 | 可以针对图纸场景定制标注界面 |
| 团队管理 | 创建标注团队，分配任务 |
| 质量控制 | 多人标注同一张图，取共识结果 |
| 自动标注 | 机器先标一遍，人工只需审核修正 |
| 直接输出到 S3 | 标注结果自动保存，格式统一 |

### 4.3 操作步骤概要

**步骤1：准备数据**
- 把图纸上传到 S3
- 创建 manifest 文件（图片列表）

**步骤2：创建标注任务**
- 选择任务类型（Bounding Box、文字等）
- 定义标签类别（text、dimension、symbol...）
- 指定标注团队

**步骤3：标注**
- 标注人员在 Web 界面上操作
- 框选文字区域，输入文字内容

**步骤4：导出结果**
- 标注完成后，结果自动保存到 S3
- 格式是 JSON，包含坐标和文字

**步骤5：转换格式**
- 用脚本把 Ground Truth 格式转成 PaddleOCR 格式
- 就可以用来训练了

### 4.4 图纸标注类别建议

| 标签 | 说明 | 示例 |
|-----|------|------|
| text | 普通文字 | 标题、注释 |
| dimension | 尺寸标注 | φ50±0.02、100mm |
| symbol | 特殊符号 | 公差符号、粗糙度符号 |
| table | 表格 | 明细表 |
| title_block | 标题栏 | 图号、材料、比例 |

### 4.5 标注界面示意

```
┌─────────────────────────────────────────────────────┐
│  [图纸图像显示区域]                                   │
│                                                     │
│     ┌─────────┐                                     │
│     │ φ50±0.02│  ← 框选这个区域                      │
│     └─────────┘                                     │
│                                                     │
├─────────────────────────────────────────────────────┤
│  标签: [dimension ▼]                                │
│  文字内容: [φ50±0.02        ]                       │
│                                                     │
│  [提交] [跳过]                                       │
└─────────────────────────────────────────────────────┘
```

---

## 五、图形相似性检索 - OpenSearch

### 5.1 这个服务解决什么问题

- 想找以前画过的类似图形
- 按关键词搜索找不到
- 需要基于图形本身的相似度来检索

### 5.2 技术方案

```
查询图形 → 提取特征向量 → 向量相似度检索 → 返回相似图形
```

### 5.3 涉及的 AWS 服务

| 服务 | 作用 |
|-----|------|
| SageMaker Endpoint | 部署特征提取模型（如 ResNet） |
| OpenSearch | 存储向量，执行 kNN 检索 |
| Lambda | 封装成 API |

### 5.4 操作步骤概要

**步骤1：部署特征提取模型**
- 用 ResNet 或 EfficientNet
- 输入图像，输出 2048 维向量

**步骤2：创建 OpenSearch 索引**
- 配置 kNN 向量字段
- 指定向量维度和相似度算法

**步骤3：入库**
- 把历史图形都提取特征
- 存入 OpenSearch

**步骤4：检索**
- 用户上传查询图形
- 提取特征向量
- 在 OpenSearch 中找最相似的 Top-K

### 5.5 检索效果

- 响应时间：毫秒级
- 支持规模：百万级图形库
- 可调参数：相似度阈值、返回数量

---

## 六、下一步计划

### 需要准备的

| 项目 | 说明 |
|-----|------|
| 测试图纸 | 50-100 张真实图纸样本 |
| 标注规范 | 定义要识别哪些类型（文字/尺寸/符号） |
| 评估标准 | 准确率目标是多少 |
| AWS 环境 | 账户权限 |

### POC 计划

| 阶段 | 内容 | 时间 |
|-----|------|------|
| 环境搭建 | AWS 账户配置、S3、ECR | 1 周 |
| 模型部署 | PaddleOCR 容器化部署到 Endpoint | 1 周 |
| 流程验证 | 标注 → 训练 → 版本管理 → 部署 | 2 周 |

---

## Q&A
