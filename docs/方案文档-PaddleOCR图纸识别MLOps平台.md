# PaddleOCR 图纸识别 MLOps 平台方案

## 一、项目背景与客户需求

### 1.1 客户核心诉求

| 序号 | 需求 | 详细说明 |
|-----|------|---------|
| 1 | 模型版本管理与增量训练 | 支持模型迭代、版本追溯、增量更新 |
| 2 | 数据标注与清洗流程 | 建立标准化的数据处理 Pipeline |
| 3 | 图纸 OCR 识别 | 识别工程图纸中的文字和特殊符号 |
| 4 | 图形相似性检索 | 基于图像特征的相似图形检索 |

### 1.2 客户现状

- 当前使用百度 PaddleOCR 框架
- 业务场景：工程图纸文字和特殊符号识别
- 已有图形相似性识别需求（基于图像算法）

### 1.3 项目目标

- ✅ 建立完整的 MLOps 平台，支持模型全生命周期管理
- ✅ 实现数据标注、清洗、训练、部署的自动化流程
- ✅ 支持增量训练，持续优化模型效果
- ✅ 扩展图形相似性检索能力

---

## 二、整体解决方案架构

### 2.1 架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                    端到端 MLOps 平台架构                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                      数据层                                   │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐              │  │
│  │  │ S3 数据湖   │  │Ground Truth│  │Data Wrangler│             │  │
│  │  │ (原始/标注) │  │ (标注平台)  │  │ (数据清洗)  │              │  │
│  │  └────────────┘  └────────────┘  └────────────┘              │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│                              ▼                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                      训练层                                   │  │
│  │  ┌─────────────────────────────────────────────────────────┐ │  │
│  │  │              SageMaker Pipelines (MLOps)                 │ │  │
│  │  │  数据预处理 → 模型训练 → 模型评估 → 条件判断 → 模型注册   │ │  │
│  │  └─────────────────────────────────────────────────────────┘ │  │
│  │                                                              │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐              │  │
│  │  │ Experiments│  │Model Monitor│ │ 增量训练    │              │  │
│  │  │ (实验追踪)  │  │ (漂移检测)  │  │ (持续优化)  │              │  │
│  │  └────────────┘  └────────────┘  └────────────┘              │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                              │                                      │
│                              ▼                                      │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │                      服务层                                   │  │
│  │  ┌────────────┐  ┌────────────┐  ┌────────────┐              │  │
│  │  │Model Registry│ │ Endpoint   │  │ OpenSearch │              │  │
│  │  │ (版本管理)  │  │ (推理服务)  │  │ (图形检索)  │              │  │
│  │  └────────────┘  └────────────┘  └────────────┘              │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

### 2.2 核心组件说明

| 组件 | AWS 服务 | 功能 | 价值 |
|-----|---------|------|------|
| 数据标注 | SageMaker Ground Truth | OCR 标注（文字框+内容） | 降低标注成本 70% |
| 数据清洗 | SageMaker Data Wrangler | 数据预处理、格式转换 | 标准化数据流程 |
| 数据存储 | Amazon S3 | 数据湖、版本管理 | 数据血缘追踪 |
| 模型训练 | SageMaker Training | PaddleOCR 训练 | GPU 弹性扩展 |
| 流程编排 | SageMaker Pipelines | MLOps 自动化 | 端到端自动化 |
| 版本管理 | Model Registry | 模型版本追踪 | 完整审批流程 |
| 模型服务 | SageMaker Endpoint | 实时推理 | 高可用、弹性伸缩 |
| 图形检索 | OpenSearch + kNN | 向量相似性检索 | 毫秒级响应 |

---

## 三、数据标注与管理流程

### 3.1 标注流程设计

```
原始图纸 → 图像预处理 → 标注任务创建 → 人工标注 → 质检审核 → 导出数据 → 训练数据集
    │           │            │            │           │          │
    ▼           ▼            ▼            ▼           ▼          ▼
  S3 上传   二值化/增强   Ground Truth   标注界面    抽检验证   PaddleOCR格式
```

### 3.2 Ground Truth 标注配置

针对图纸场景的标签类型：

| 标签类型 | 说明 | 示例 |
|---------|------|------|
| text | 普通文字 | 标题、注释、说明 |
| dimension | 尺寸标注 | φ50±0.02、100mm |
| symbol | 特殊符号 | 公差符号、表面粗糙度 |
| table | 表格区域 | 明细表、参数表 |
| title_block | 标题栏 | 图号、名称、材料 |

### 3.3 数据格式转换

Ground Truth 输出 → PaddleOCR 训练格式：

```
# PaddleOCR 标签格式 (train.txt)
images/drawing_001.png	图号：DWG-2024-001
images/drawing_001.png	材料：45#钢
images/drawing_002.png	φ50±0.02
```

---

## 四、模型训练与版本管理

### 4.1 Model Registry 功能

| 功能 | 说明 |
|-----|------|
| 版本追踪 | v1.0 → v1.1 → v2.0，完整版本历史 |
| 模型元数据 | 训练参数、数据集、评估指标 |
| 审批流程 | Pending → Approved → Deployed |
| 模型比较 | 多版本指标对比分析 |
| 自动部署 | 审批通过后自动部署到端点 |

### 4.2 模型生命周期

```
┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐   ┌─────┐
│ 开发 │──▶│ 训练 │──▶│ 评估 │──▶│ 注册 │──▶│ 审批 │──▶│ 部署 │──▶│ 监控 │
└─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘   └─────┘
                                                              │
                                                              ▼
                                                         ┌─────────┐
                                                         │ 重训练  │
                                                         └─────────┘
```

---

## 五、增量训练方案

### 5.1 增量训练 vs 全量训练

| 维度 | 全量训练 | 增量训练 |
|-----|---------|---------|
| 训练时间 | 长（小时级） | 短（分钟级） |
| 数据需求 | 全部历史数据 | 仅新增数据 |
| 计算成本 | 高 | 低（节省 50%+） |
| 适用场景 | 模型架构变更 | 持续优化迭代 |
| 风险 | 低 | 需防止灾难性遗忘 |

### 5.2 增量训练流程

```python
# SageMaker 增量训练关键配置
estimator = Estimator(
    image_uri=training_image_uri,
    model_uri='s3://bucket/models/v1/model.tar.gz',  # 基础模型
    hyperparameters={
        'epochs': 50,
        'learning_rate': 0.0001,      # 小学习率
        'freeze_backbone': 'true',     # 冻结骨干网络
        'mixed_data_ratio': '0.3'      # 混合 30% 旧数据
    }
)
```

### 5.3 防止灾难性遗忘策略

| 策略 | 说明 | 推荐程度 |
|-----|------|---------|
| 混合新旧数据 | 新数据 70% + 旧数据 30% | ⭐⭐⭐⭐⭐ |
| 小学习率 | 0.0001（比初始训练小 10 倍） | ⭐⭐⭐⭐⭐ |
| 冻结骨干网络 | 只训练识别头 | ⭐⭐⭐⭐ |
| 正则化 | L2 正则化、Dropout | ⭐⭐⭐ |
| 知识蒸馏 | 用旧模型指导新模型 | ⭐⭐⭐ |

### 5.4 增量训练 Pipeline

```
新数据到达 → 数据预处理 → 加载基础模型 → 增量训练 → 模型评估 → 条件判断 → 模型注册
                                                        │
                                                        ▼
                                              准确率 ≥ 阈值？
                                              │         │
                                             是         否
                                              │         │
                                              ▼         ▼
                                           注册 v2    告警通知
```

---

## 六、图形相似性检索方案

### 6.1 技术架构

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│  查询图形   │───▶│ 特征提取    │───▶│ 向量检索    │───▶│ Top-K 结果  │
│  (图纸局部) │    │ (ResNet50)  │    │ (OpenSearch)│    │ (相似图形)  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
                         │
                         ▼
                   SageMaker Endpoint
                   (特征提取服务)
```

### 6.2 组件说明

| 组件 | 功能 | 技术选型 |
|-----|------|---------|
| 特征提取 | 图像 → 2048 维向量 | ResNet50 / EfficientNet |
| 向量存储 | 存储图形特征向量 | OpenSearch kNN |
| 相似检索 | 余弦相似度检索 | HNSW 算法 |
| API 服务 | 对外接口 | API Gateway + Lambda |

### 6.3 检索性能

| 指标 | 数值 |
|-----|------|
| 索引规模 | 支持百万级图形 |
| 检索延迟 | < 100ms |
| 召回率 | > 95%（Top-10） |

---

## 七、演示方案

### 7.1 演示数据集

#### 推荐数据集组合

| 用途 | 数据集 | 规模 | 说明 |
|-----|-------|------|------|
| 英文 OCR | ICDAR 2015 | 1,500 张 | 场景文字检测标准数据集 |
| 中文 OCR | ICDAR 2019 ReCTS | 25,000 张 | 中文招牌/标志 |
| 文档表格 | FUNSD | 199 张 | 表单理解 |
| 客户数据 | 真实图纸样本 | 50-100 张 | 增量训练演示 |

#### 数据集下载

```bash
# PaddleOCR 官方数据集
wget https://paddleocr.bj.bcebos.com/dataset/ICDAR2015.tar
wget https://paddleocr.bj.bcebos.com/dataset/chinese_ocr.tar
```

### 7.2 演示流程

| 序号 | 演示内容 | 时长 | 重点展示 |
|-----|---------|------|---------|
| 1 | 方案架构讲解 | 15 分钟 | 整体架构、核心价值 |
| 2 | 数据标注流程 | 10 分钟 | Ground Truth 界面、标注效率 |
| 3 | 模型版本管理 | 10 分钟 | Model Registry、版本对比 |
| 4 | 增量训练演示 | 15 分钟 | Pipeline 执行、v1→v2 效果对比 |
| 5 | 端到端推理 | 10 分钟 | 图纸识别效果展示 |
| 6 | 成本估算 | 5 分钟 | 不同规模成本分析 |
| 7 | Q&A | 10 分钟 | 客户问题解答 |

### 7.3 演示代码清单

| 文件 | 功能 |
|-----|------|
| `01_ground_truth_labeling.py` | Ground Truth 标注流程 |
| `02_model_registry.py` | Model Registry 版本管理 |
| `03_incremental_training_pipeline.py` | 增量训练 Pipeline |
| `04_image_similarity_search.py` | 图形相似性检索 |
| `05_end_to_end_inference.py` | 端到端推理演示 |
| `06_cost_estimation.py` | 成本估算工具 |

---

## 八、成本估算

### 8.1 月度成本估算（生产环境参考）

| 服务 | 配置 | 月成本（USD） |
|-----|------|--------------|
| Ground Truth | 10,000 张标注（私有团队） | $100 |
| SageMaker Training | ml.p3.2xlarge × 20h × 4 次 | $306 |
| SageMaker Endpoint | ml.m5.xlarge × 24/7 | $194 |
| S3 Storage | 100GB 数据 + 10GB 模型 | $3 |
| OpenSearch | t3.small.search × 2 节点 | $52 |
| **合计** | | **~$655/月** |

### 8.2 不同规模成本对比

| 场景 | 标注 | 训练 | 推理 | 存储 | 总计/月 |
|-----|------|------|------|------|--------|
| POC | $50 | $76 | $47 | $1 | ~$174 |
| 开发环境 | $50 | $153 | $97 | $2 | ~$350 |
| 生产环境 | $100 | $306 | $388 | $5 | ~$850 |

### 8.3 成本优化建议

| 优化项 | 方法 | 预期节省 |
|-------|------|---------|
| 训练成本 | 使用 Spot 实例 | 60-90% |
| 推理成本 | 自动扩缩容 / Serverless | 30-50% |
| 存储成本 | S3 Intelligent-Tiering | 20-40% |
| 标注成本 | 主动学习减少标注量 | 30-50% |

---

## 九、实施路线图

### 9.1 阶段规划

| 阶段 | 时间 | 目标 | 交付物 |
|-----|------|------|--------|
| POC | 2-4 周 | 验证技术可行性 | 原型系统、效果报告 |
| MVP | 4-6 周 | 核心功能上线 | 标注+训练+推理流程 |
| 生产 | 2-4 周 | 全功能部署 | 完整 MLOps 平台 |
| 优化 | 持续 | 持续迭代优化 | 模型效果提升 |

### 9.2 POC 阶段详细计划

| 周次 | 任务 | 产出 |
|-----|------|------|
| 第 1 周 | 环境搭建、数据准备 | AWS 环境、测试数据集 |
| 第 2 周 | 基础模型训练部署 | PaddleOCR v1 模型 |
| 第 3 周 | 增量训练验证 | v1→v2 效果对比 |
| 第 4 周 | 整合测试、报告 | POC 报告、演示 |

### 9.3 成功标准

| 指标 | POC 目标 | 生产目标 |
|-----|---------|---------|
| OCR 准确率 | ≥ 85% | ≥ 92% |
| 推理延迟 | < 500ms | < 200ms |
| 增量训练时间 | < 2 小时 | < 1 小时 |
| 模型迭代周期 | 手动触发 | 自动化 |

---

## 十、风险与应对

| 风险 | 影响 | 应对措施 |
|-----|------|---------|
| 图纸数据敏感 | 数据安全 | VPC 部署、数据脱敏 |
| 特殊符号识别差 | 准确率不达标 | 定制字符集、增量训练 |
| 模型漂移 | 效果下降 | Model Monitor 监控 |
| 成本超预期 | 预算风险 | Spot 实例、自动扩缩容 |

---

## 十一、附录

### 11.1 技术栈清单

| 类别 | 技术/服务 |
|-----|----------|
| OCR 框架 | PaddleOCR (PP-OCRv4) |
| ML 平台 | Amazon SageMaker |
| 数据标注 | SageMaker Ground Truth |
| 流程编排 | SageMaker Pipelines |
| 模型管理 | SageMaker Model Registry |
| 向量检索 | Amazon OpenSearch |
| 存储 | Amazon S3 |
| 容器 | Amazon ECR |
| API | API Gateway + Lambda |

### 11.2 参考资源

- [PaddleOCR GitHub](https://github.com/PaddlePaddle/PaddleOCR)
- [SageMaker 文档](https://docs.aws.amazon.com/sagemaker/)
- [AWS MLOps 最佳实践](https://aws.amazon.com/solutions/implementations/mlops-workload-orchestrator/)

### 11.3 联系方式

如有问题，请联系项目团队。

---

*文档版本: v1.0*
*更新日期: 2026-01-06*
