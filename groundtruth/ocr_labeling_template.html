<!DOCTYPE html>
<html>

<head>
    <script src="https://assets.crowd.aws/crowd-html-elements.js"></script>
    <style>
        :root {
            --primary-color: #232f3e;
            --secondary-color: #ff9900;
            --border-color: #d5dbdb;
        }

        .container {
            display: flex;
            height: 100vh;
            font-family: 'Amazon Ember', Arial, sans-serif;
        }

        .image-panel {
            flex: 3;
            padding: 10px;
            overflow: auto;
        }

        .annotation-panel {
            flex: 1;
            min-width: 300px;
            max-width: 400px;
            padding: 15px;
            background: #f8f9fa;
            border-left: 1px solid var(--border-color);
            overflow-y: auto;
        }

        .annotation-panel h3 {
            margin: 0 0 15px 0;
            color: var(--primary-color);
            border-bottom: 2px solid var(--secondary-color);
            padding-bottom: 10px;
        }

        .annotation-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .annotation-item.active {
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 2px rgba(255, 153, 0, 0.3);
        }

        .annotation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .annotation-label {
            font-weight: bold;
            color: var(--primary-color);
        }

        .annotation-coords {
            font-size: 11px;
            color: #666;
        }

        .text-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .text-input:focus {
            outline: none;
            border-color: var(--secondary-color);
        }

        .type-select {
            width: 100%;
            padding: 6px;
            margin-top: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 12px;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .stats {
            background: var(--primary-color);
            color: white;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 13px;
        }

        .instructions {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-radius: 4px;
            padding: 10px;
            margin-bottom: 15px;
            font-size: 12px;
        }

        .empty-state {
            text-align: center;
            color: #666;
            padding: 20px;
        }

        crowd-bounding-box {
            width: 100%;
        }
    </style>
</head>

<body>
    <crowd-form>
        <div class="container">
            <!-- å·¦ä¾§ï¼šå›¾åƒæ ‡æ³¨åŒº -->
            <div class="image-panel">
                <crowd-bounding-box id="bbox-tool" name="boundingBoxes"
                    src="{{ task.input.taskObject | grant_read_access }}" header="P&ID å›¾çº¸æ–‡å­—æ ‡æ³¨"
                    labels="['text', 'equipment_id', 'dimension', 'tag', 'note']">
                    <full-instructions header="P&ID å›¾çº¸ OCR æ ‡æ³¨æŒ‡å—">
                        <h3>æ ‡æ³¨ç›®æ ‡</h3>
                        <p>æ¡†é€‰å›¾çº¸ä¸­æ‰€æœ‰å¯è¯†åˆ«çš„æ–‡å­—åŒºåŸŸï¼Œå¹¶è¾“å…¥å¯¹åº”çš„æ–‡å­—å†…å®¹ã€‚</p>

                        <h3>æ ‡æ³¨ç±»åˆ«</h3>
                        <ul>
                            <li><b>text</b> - æ™®é€šæ–‡å­—</li>
                            <li><b>equipment_id</b> - è®¾å¤‡ç¼–å· (å¦‚ P-101, V-201)</li>
                            <li><b>dimension</b> - å°ºå¯¸æ ‡æ³¨ (å¦‚ DN50, 2")</li>
                            <li><b>tag</b> - ä»ªè¡¨æ ‡ç­¾ (å¦‚ FIC-101, TT-201)</li>
                            <li><b>note</b> - å¤‡æ³¨è¯´æ˜</li>
                        </ul>

                        <h3>æ ‡æ³¨è§„èŒƒ</h3>
                        <ol>
                            <li>æ¡†é€‰æ—¶å°½é‡è´´åˆæ–‡å­—è¾¹ç•Œï¼Œç•™å°‘é‡è¾¹è·</li>
                            <li>å€¾æ–œæ–‡å­—æŒ‰å®é™…æ–¹å‘æ¡†é€‰</li>
                            <li>ç‰¹æ®Šç¬¦å·ä½¿ç”¨çº¦å®šç¼–ç ï¼šÎ¦â†’Î¦, Â°â†’Â°, Â±â†’Â±</li>
                            <li>æ¨¡ç³Šä¸æ¸…çš„æ–‡å­—æ ‡æ³¨ä¸º [unclear]</li>
                            <li>æ¯ä¸ªç‹¬ç«‹æ–‡å­—å—å•ç‹¬æ¡†é€‰</li>
                        </ol>

                        <h3>è·³è¿‡æ ‡æ³¨</h3>
                        <ul>
                            <li>çº¯å›¾å½¢ç¬¦å·ï¼ˆé˜€é—¨ã€æ³µç­‰è®¾å¤‡å›¾æ ‡ï¼‰</li>
                            <li>çº¿æ¡ã€ç®­å¤´ç­‰è£…é¥°å…ƒç´ </li>
                            <li>å›¾æ¡†è¾¹ç•Œçº¿</li>
                        </ul>
                    </full-instructions>

                    <short-instructions>
                        <p>1. ç”¨çŸ©å½¢æ¡†é€‰æ–‡å­—åŒºåŸŸ</p>
                        <p>2. é€‰æ‹©åˆé€‚çš„æ ‡ç­¾ç±»åˆ«</p>
                        <p>3. åœ¨å³ä¾§é¢æ¿è¾“å…¥æ–‡å­—å†…å®¹</p>
                    </short-instructions>
                </crowd-bounding-box>
            </div>

            <!-- å³ä¾§ï¼šæ–‡å­—è¾“å…¥é¢æ¿ -->
            <div class="annotation-panel">
                <h3>ğŸ“ æ–‡å­—å†…å®¹æ ‡æ³¨</h3>

                <div class="instructions">
                    <b>æ“ä½œæç¤ºï¼š</b>æ¡†é€‰æ–‡å­—åï¼Œåœ¨ä¸‹æ–¹è¾“å…¥å¯¹åº”çš„æ–‡å­—å†…å®¹
                </div>

                <div class="stats" id="stats">
                    å·²æ ‡æ³¨: <span id="count">0</span> ä¸ªåŒºåŸŸ
                </div>

                <div id="annotation-list">
                    <div class="empty-state">
                        è¯·åœ¨å·¦ä¾§å›¾åƒä¸Šæ¡†é€‰æ–‡å­—åŒºåŸŸ
                    </div>
                </div>

                <!-- éšè—å­—æ®µå­˜å‚¨æ–‡å­—å†…å®¹ -->
                <input type="hidden" id="transcriptions" name="transcriptions" value="{}">
            </div>
        </div>

        <script>
            // å­˜å‚¨æ–‡å­—å†…å®¹
            let transcriptionData = {};

            // è·å– bounding box ç»„ä»¶
            const bboxTool = document.getElementById('bbox-tool');
            const annotationList = document.getElementById('annotation-list');
            const transcriptionsInput = document.getElementById('transcriptions');
            const countSpan = document.getElementById('count');

            // ç›‘å¬æ ‡æ³¨å˜åŒ–
            function updateAnnotationPanel() {
                // ç­‰å¾…ç»„ä»¶åŠ è½½
                setTimeout(() => {
                    const annotations = bboxTool.value ? bboxTool.value.boundingBoxes : [];

                    if (!annotations || annotations.length === 0) {
                        annotationList.innerHTML = '<div class="empty-state">è¯·åœ¨å·¦ä¾§å›¾åƒä¸Šæ¡†é€‰æ–‡å­—åŒºåŸŸ</div>';
                        countSpan.textContent = '0';
                        return;
                    }

                    countSpan.textContent = annotations.length;

                    let html = '';
                    annotations.forEach((ann, idx) => {
                        const savedText = transcriptionData[idx] || '';
                        const coords = `(${Math.round(ann.left)}, ${Math.round(ann.top)}) - ${Math.round(ann.width)}x${Math.round(ann.height)}`;

                        html += `
              <div class="annotation-item" data-index="${idx}">
                <div class="annotation-header">
                  <span class="annotation-label">åŒºåŸŸ ${idx + 1} [${ann.label}]</span>
                </div>
                <div class="annotation-coords">${coords}</div>
                <input type="text" 
                       class="text-input" 
                       data-index="${idx}"
                       placeholder="è¾“å…¥æ–‡å­—å†…å®¹..."
                       value="${savedText}"
                       onchange="updateTranscription(${idx}, this.value)"
                       onfocus="highlightAnnotation(${idx})"
                >
                <select class="type-select" data-index="${idx}" onchange="updateType(${idx}, this.value)">
                  <option value="">-- æ–‡å­—ç±»å‹ (å¯é€‰) --</option>
                  <option value="chinese">ä¸­æ–‡</option>
                  <option value="english">è‹±æ–‡</option>
                  <option value="number">æ•°å­—</option>
                  <option value="mixed">æ··åˆ</option>
                  <option value="symbol">ç¬¦å·</option>
                </select>
              </div>
            `;
                    });

                    annotationList.innerHTML = html;
                }, 100);
            }

            // æ›´æ–°æ–‡å­—å†…å®¹
            function updateTranscription(index, text) {
                transcriptionData[index] = text;
                transcriptionsInput.value = JSON.stringify(transcriptionData);
            }

            // æ›´æ–°æ–‡å­—ç±»å‹
            function updateType(index, type) {
                if (!transcriptionData.types) {
                    transcriptionData.types = {};
                }
                transcriptionData.types[index] = type;
                transcriptionsInput.value = JSON.stringify(transcriptionData);
            }

            // é«˜äº®å½“å‰æ ‡æ³¨
            function highlightAnnotation(index) {
                document.querySelectorAll('.annotation-item').forEach((item, i) => {
                    item.classList.toggle('active', i === index);
                });
            }

            // ç›‘å¬ bounding box å˜åŒ–
            if (bboxTool) {
                // ä½¿ç”¨ MutationObserver ç›‘å¬å˜åŒ–
                const observer = new MutationObserver(updateAnnotationPanel);
                observer.observe(bboxTool, { attributes: true, childList: true, subtree: true });

                // å®šæœŸæ£€æŸ¥æ›´æ–°
                setInterval(updateAnnotationPanel, 500);
            }

            // åˆå§‹åŒ–
            document.addEventListener('DOMContentLoaded', updateAnnotationPanel);
        </script>
    </crowd-form>
</body>

</html>